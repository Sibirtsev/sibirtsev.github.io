{{/*
  SEO partial: meta description, canonical, robots, hreflang, Open Graph,
  Twitter Cards, and JSON-LD for Website/Organization/Article.
*/}}

{{- $site := .Site -}}
{{- $params := $site.Params -}}

{{/* Description resolution: front matter > .Description > .Summary > site param */}}
{{- $rawDesc := or .Params.description (or .Description (or .Summary $params.description)) -}}
{{- $description := cond (gt (len (plainify (htmlUnescape $rawDesc))) 0) (truncate 160 (plainify (htmlUnescape $rawDesc))) "" -}}

{{/* Image resolution: front matter images[] | image | site params.images[] | logo | apple-touch as fallback */}}
{{- $images := slice -}}
{{- if .Params.images -}}
  {{- $images = .Params.images -}}
{{- else if .Params.image -}}
  {{- $images = (slice .Params.image) -}}
{{- else if $params.images -}}
  {{- $images = $params.images -}}
{{- end -}}
{{- $logo := or $params.logo "/apple-touch-icon.png" -}}
{{- if (eq (len $images) 0) -}}
  {{- $images = (slice $logo) -}}
{{- end -}}
{{- $image := index $images 0 | absURL -}}

{{/* Canonical URL */}}
<link rel="canonical" href="{{ .Permalink }}">

{{/* hreflang alternates for translations */}}
{{- if .IsTranslated -}}
  {{- range .AllTranslations -}}
    <link rel="alternate" href="{{ .Permalink }}" hreflang="{{ .Lang }}" />
  {{- end -}}
  <link rel="alternate" href="{{ .Permalink }}" hreflang="x-default" />
{{- end -}}

{{/* Robots: honor front matter noindex or drafts */}}
{{- $noindex := or .Params.noindex (or (eq .Draft true) (or $params.noindex false)) -}}
<meta name="robots" content="{{ if $noindex }}noindex, nofollow{{ else }}index, follow{{ end }}">

{{- with $description }}
<meta name="description" content="{{ . }}">
{{- end }}

{{/* Open Graph */}}
{{- $isArticle := or .IsPage (eq .Section "posts") -}}
<meta property="og:type" content="{{ if $isArticle }}article{{ else }}website{{ end }}">
<meta property="og:site_name" content="{{ $site.Title }}">
<meta property="og:title" content="{{ .Title }}">
{{- with $description }}<meta property="og:description" content="{{ . }}">{{- end }}
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:image" content="{{ $image }}">
{{- if $isArticle -}}
  {{- with .Date }}<meta property="article:published_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}">{{ end -}}
  {{- with .Lastmod }}<meta property="article:modified_time" content="{{ .Format "2006-01-02T15:04:05Z07:00" }}">{{ end -}}
  {{- with .Params.tags }}
    {{- range . }}<meta property="article:tag" content="{{ . }}">{{ end -}}
  {{- end -}}
{{- end -}}

{{/* Twitter Cards */}}
<meta name="twitter:card" content="{{ if $image }}summary_large_image{{ else }}summary{{ end }}">
{{- with $params.twitterSite }}<meta name="twitter:site" content="{{ . }}">{{- end }}
{{- with $params.twitterCreator }}<meta name="twitter:creator" content="{{ . }}">{{- end }}
<meta name="twitter:title" content="{{ .Title }}">
{{- with $description }}<meta name="twitter:description" content="{{ . }}">{{- end }}
<meta name="twitter:image" content="{{ $image }}">

{{/* JSON-LD */}}
{{- if .IsHome -}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "url": "{{ $site.BaseURL }}",
  "name": "{{ $site.Title }}",
  "description": {{ if $description }}"{{ $description }}"{{ else }}null{{ end }},
  "inLanguage": "{{ $site.LanguageCode }}"
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "url": "{{ $site.BaseURL }}",
  "name": "{{ $site.Title }}",
  "logo": "{{ $logo | absURL }}"
}
</script>
{{- else if $isArticle -}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {"@type": "WebPage", "@id": "{{ .Permalink }}"},
  "headline": "{{ .Title }}",
  "description": {{ if $description }}"{{ $description }}"{{ else }}null{{ end }},
  "image": ["{{ $image }}"],
  "author": {
    "@type": "Person",
    "name": {{ if .Params.author }}"{{ .Params.author }}"{{ else if $params.author }}"{{ $params.author }}"{{ else }}""{{ end }}
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{ $site.Title }}",
    "logo": {"@type": "ImageObject", "url": "{{ $logo | absURL }}"}
  },
  "datePublished": {{ with .Date }}"{{ .Format "2006-01-02T15:04:05Z07:00" }}"{{ else }}null{{ end }},
  "dateModified": {{ with .Lastmod }}"{{ .Format "2006-01-02T15:04:05Z07:00" }}"{{ else }}null{{ end }},
  "inLanguage": "{{ $site.LanguageCode }}"
}
</script>
{{- end -}}

